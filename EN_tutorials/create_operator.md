# Create Operator to implement custom model

Phantoscope is a cloud-native image search engine based on Milvus and deep learning. We know that the VGG16 model is used in the [Phantscope Quick Start](https://github.com/zilliztech/phantoscope/tree/0.1.0/docs/site/en/quickstart) to get a representation of the image feature vector. Then if you want to switch to a more accurate ResNet model to [customize the Operator](https://github.com/zilliztech/phantoscope/blob/0.1.0/operators/HowToAddAnOperator_en.md), how should this be achieved?

Since Phantoscope is fully compatible with mainstream deep learning frameworks such as Tensorflow, Pytorch, TensorRT, ONNX, XGBoost, etc., you can refer to this tutorial if you want to use your own deep learning model.

## 1. Preparation

- Some experience with Python

- Understand gRPC and protobuf

- Master basic Docker commands

- Familiarity with [Phantoscop basics](https://github.com/zilliztech/phantoscope/tree/0.1.0#phantoscope-basics)

- Run [Phantscop Quick Start](https://github.com/zilliztech/phantoscope/tree/0.1.0/docs/site/en/quickstart) successfully , to check the status of all containers:

```shell
$ docker-compose ps
# You are expected to see the following output
 Name                   Command                          State   Ports
 -----------------------------------------------------------------------------------------
 phantoscope_api_1      /usr/bin/gunicorn3 -w 4 -b ...   Up      0.0.0.0:5000->5000/tcp
 phantoscope_milvus_1   /var/lib/milvus/docker-ent ...   Up      0.0.0.0:19530->19530/tcp, 0.0.0.0:8080->8080/tcp
 phantoscope_minio_1    /usr/bin/docker-entrypoint ...   Up      0.0.0.0:9000->9000/tcp
 phantoscope_mysql_1    docker-entrypoint.sh mysqld      Up      0.0.0.0:3306->3306/tcp
 phantoscope_vgg_1      python3 server.py                Up      0.0.0.0:50001->50001/tcp
```




## 2. Customize Operator

The next step is to implement a custom Operator implementation based on the ResNet algorithm. The most basic Operator structure is shown in the **phantoscope/operators/example-custom-operaotor** directory:

1. Scripts for downloading the model files are usually stored in the **data** directory and used to download the model when making the mirror image.
2. Under the **rpc** directory is the python file generated by gRPC.
3. The **server** file in the home directory is usually used to store the gRPC server's associated logic.
4. The **custom_operator** file in the home directory is used to implement the interface required by the rpc file.

We will create Operator implementations of custom resnet50-encoder models based on this structure.

### 2.1 Create Directory

Create **resnet50-encoder** directory based on **example-custom-operaotor** content:

```bash
$ cp -rf example-custom-operator resnet50-encoder
$ cd resnet50-encoder
```

### 2.2 Customize Model

#### 2.2.1 Download Model

- Edit the **data/prepare_model.sh** script. Download the model via the `wget` command.

```bash
file=resnet50_weights_tf_dim_ordering_tf_kernels_notop.h5
url=https://github.com/fchollet/deep-learning-models/releases/download/v0.1/resnet50_weights_tf_dim_ordering_tf_kernels_notop.h5

if [[ ! -f "${file}" ]]; then
   echo "[INFO] Model tar package does not exist, begin to download..."
   wget ${url} -O ${file}
   echo "[INFO] Model tar package download successfully!"
fi

if [[ -f "${file}" ]];then
   echo "[INFO] Model has been prepared successfully!"
   exit 0
fi
```

  > Make sure to run the script to download the model file. If you are using your own model, change the `file` and `url` parameters in the script to your own model name and download address.

#### 2.2.2 Customize Operator

- Description of the interface implemented in **custom_operator.py**：

| Function | Description |
| -------------- | ----------- |
| __ init __(self) | Initialize functions |
| run(self, images, urls) | The model encode function, whose parameters include an image file or image urls <br />The function returns a feature vector whose result is that the model converts the image to a list type. |
| name(self) | Return the name of a custom Operator. |
| type(self) | Return a custom Operator type, such as encoder or processor. |
| input(self) | Return model input for a custom Operator, such as image. |
| output(self) | Return the model output of a custom Operator, such as a vector. |
| dimension(self) | Return the dimension of a custom Operator's model output vector, such as 2048. |
| metric_type(self) | Return the model metric of a custom Operator, such as L2 (Euclidean distance). |

- This article customizes the `CustomOperator` based on the ResNet50 model, refer to this [resnet50_custom_operator.py](../tutorials/script/custom_operator.py) code:

```bash
# download custom_operator.py to resnet50-encoder floder
$ mv custom_operator.py custom_operator.py.bak
$ wget https://raw.githubusercontent.com/zilliztech/phantoscope-bootcamp/master/tutorials/script/custom_operator.py
```

- Add dependencies according to the **custom_operator.py **code in the **requirements.txt**

```bash
Keras==2.3.1
tensorflow==1.14.0
grpcio==1.27.2
pillow
```

  > If you are using your own model, please modify the interface functions in **custom_operator.py** and the dependencies in **requirements.txt**.
  >
  > If your model requires a GPU to extract features, please add the dependencies to **requirements-gpu.txt**.

#### 2.2.3 Adjust the gRPC service

The **server.py** file implements the call logic for a custom Operator. Defined Operator types tune the gRPC service, and this article implements the ResNet-based encoder method, then the code module on the processor is removed:

```bash
# download server.py to resnet50-encoder floder
$ mv server.py server.py.bak
$ wget https://raw.githubusercontent.com/zilliztech/phantoscope-bootcamp/master/tutorials/script/server.py
```

> If your model implements a processor type of functionality, you should remove the code associated with the encoder.

### 2.3 Build Docker mirror image

In summary, you have customized an Operactor structure by modifying the **data**, **server** and **custom_operator** files, and will run the `make cpu` command to build a custom Operator Docker mirror image:

```bash
$ mv Makefile Makefile.bak
$ wget https://raw.githubusercontent.com/zilliztech/phantoscope-bootcamp/master/tutorials/script/Makefile
$ make cpu
```

We can change the `IMAGE_NAME` custom image name in the [Makefile](../tutorials/script/Makefile). For example, `resnet50_encoder`, then by running `docker images` command will see a mirror image named `psoperator/resnet50_encoder:latest`.

### 2.4 Start the container and verify

- Start the container

```bash
$ export LOCAL_ADDRESS=$(ip a | grep -Eo 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -Eo '([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1'| head -n 1)
$ docker run -p 52001:52001 -e OP_ENDPOINT=${LOCAL_ADDRESS}:52001 -d psoperator/resnet50_encoder:latest
```

  The parameters of the command are described as follows:

| Parameter                             | Description                                                  |
| ------------------------------------- | ------------------------------------------------------------ |
| -p 52001:52001                        | -p stands for port mapping, mapping the local 52001 port to the 52001 port in Docker |
| -e OP_ENDPOINT=${LOCAL_ADDRESS}:52001 | -e Defines Docker's environment variable, the port of the container's OP_ENDPOINT environment variable needs to be the same as the port that -p maps to locally. |
| psoperator/resnet50_encoder:latest    | Docker's mirror image names, please change the image name to the one you customized in the previous step. |

After the container is started, you can run `docker logs <resnet50_encoder container id>` to see the status.

- Verify

```bash
# Download and run the test_operator.py
$ wget https://raw.githubusercontent.com/zilliztech/phantoscope-bootcamp/master/tutorials/script/test_custom_operator.py
$ python3 test_custom_operator.py -e ${LOCAL_ADDRESS}:52001
# You are expected to see the following output
INFO:root:Begin to test: endpoint-192.168.1.85:52001
INFO:root:Endpoint information: {'name': 'resnet50_encoder', 'endpoint': '192.168.1.85:52001', 'type': 'encoder', 'input': 'image', 'output': 'vector', 'dimension': '2048', 'metric_type': 'L2'}
INFO:root:Endpoint health: healthy
INFO:root:Result :
  vector size: 1;  data size: 0
INFO:root:  vector dim: 2048
INFO:root:All tests over.
```

> The parameters to run the test script -e correspond to the contents of `OP_ENDPOINT` when the container is started.
>
> You should run the validation code approximately 3 minutes after starting the container because it takes some time to initialize the Operator.



## 3. Register Operator

- View the operational status of the containers, including the five containers that were started at [Phantoscope Quick Start](https://github.com/zilliztech/phantoscope/tree/0.1.0/docs/site/en/quickstart), as well as the containers of the custom Operator that were started in the previous step.

```bash
$ docker ps
CONTAINER ID        IMAGE                                       COMMAND                  CREATED             STATUS              PORTS                                                NAMES
160fe088d86e        psoperator/resnet50_encoder:latest          "python3 server.py"      6 minutes ago       Up 6 minutes        80/tcp, 0.0.0.0:52001->52001/tcp                     bold_kilby
2fd3b14d3577        psoperator/vgg16:latest                     "python3 server.py"      10 minutes ago       Up 10 minutes           0.0.0.0:50001->50001/tcp                             phantoscope_vgg_1
5f48b00f1b6c        phantoscope/api-server:v0.1.0               "/usr/bin/gunicorn3 …"   10 minutes ago       Up 10 minutes           0.0.0.0:5000->5000/tcp                               phantoscope_api_1
0a96852998b2        mysql:5.6                                   "docker-entrypoint.s…"   10 minutes ago       Up 10 minutes           0.0.0.0:3306->3306/tcp                               phantoscope_mysql_1
a8a8291d5217        milvusdb/milvus:0.7.0-cpu-d031120-de409b    "/var/lib/milvus/doc…"   10 minutes ago       Up 10 minutes           0.0.0.0:8080->8080/tcp, 0.0.0.0:19530->19530/tcp     phantoscope_milvus_1
2c8f0dc350a7        minio/minio:latest                          "/usr/bin/docker-ent…"   10 minutes ago       Up 10 minutes           0.0.0.0:9000->9000/tcp                               phantoscope_minio_1
```

Register the `resnet50-encoder` Operator to the In Phantoscope:

```bash
$ curl --location --request POST ${LOCAL_ADDRESS}':5000/v1/operator/regist' \
--header 'Content-Type: application/json' \
--data '{
    "endpoint": "'${LOCAL_ADDRESS}':52001",     
    "name": "resnet50_encoder"
}'
```

  > Port 52001 is the port that is mapped when starting the custom Operator container.
  >
  > `name` parameter resnet50_encoder is the port mapped on the custom_ Operator name as defined in operator.py.

The result of a correct run will return the following information for the corresponding Operator:

```bash
{"_name": "resnet50_encoder", "_backend": "resnet50_encoder", "_type": "encoder", "_input": "image", "_output": "vector", "_endpoint": "127.0.0.1:52001", "_metric_type": "L2", "_dimension": 2048}
```



## 4. Create Application

Now that we have registered our custom Operator into Phantoscope, we can create an Application that implements the graph search, see [Create an Application](./create_application.md).

> When creating the Phantoscope Application we have already registered the Operator in the previous step, so this step can be skipped. When creating the Pipeline next, please **NOTICE** change the `encoder` parameter to `resnet50_encoder`.



## 5. VGG model comparison

This article implements a ResNet-based model to search for a picture based on a picture, and compares the effect with the Application search for the same picture created by the Vgg16 model as follows:

- VGG model retrieval effect

![](../tutorials/pic/vgg16.png)

- Custom Operator retrieval effect (ResNet)

![](../tutorials/pic/resnet50.png)

We know that the Vgg model is less accurate than ResNet, and the results retrieved in this paper are also better for the latter.

